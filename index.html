<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Il Rituale — Combinazione di Simboli</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap');

  :root{
    --bg:#050505; --fg:#e6e6e6; --muted:#9aa0a6;
    --accent:#2bff88; --accent2:#6bffda;
    --pumpkin:#ff7a18; --stone:#5de6b3;
    --card:#0d0d0d; --ok:#22c55e; --err:#ff4d4d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(circle at 50% 15%, #111 0%, #000 80%);color:var(--fg);font-family:'Cinzel Decorative', serif}
  .page{max-width:1600px;margin:0 auto;padding:clamp(12px,2vw,24px);display:flex;flex-direction:column;align-items:center;text-align:center}

  /* HERO dimezzata */
  .hero{width:100%;max-width:min(500px,50vw);margin:0 auto clamp(10px,2vw,18px)}
  .hero img{width:100%;height:auto;display:block;border-radius:10px}
  .hero-fallback{width:100%;padding:clamp(16px,2vw,28px);border:2px dashed rgba(43,255,136,.35);border-radius:10px;color:var(--accent2)}

  h1{font-size:clamp(24px,5vw,42px);margin:clamp(8px,1.5vw,12px) 0;color:var(--accent);text-shadow:0 0 12px var(--accent),0 0 28px var(--accent2);letter-spacing:.06em}
  .sub{color:var(--muted);margin:0 0 clamp(12px,2vw,18px);font-size:clamp(14px,2vw,18px)}

  /* COMBINAZIONE */
  .panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(220px,42vw),1fr));gap:clamp(12px,2vw,20px);width:100%;max-width:min(1200px,96vw);padding:clamp(12px,2vw,16px);border-radius:16px;background:rgba(20,20,20,.85);box-shadow:0 0 40px rgba(43,255,136,.25),inset 0 0 20px rgba(43,255,136,.15)}
  .slot{background:radial-gradient(300px 300px at 50% 30%, rgba(43,255,136,.08), transparent 70%), var(--card);border:2px solid rgba(43,255,136,.3);border-radius:16px;padding:clamp(8px,1.8vw,12px);display:flex;align-items:center;justify-content:center;gap:clamp(8px,1.5vw,10px);min-height:clamp(200px,28vw,320px);box-shadow:inset 0 0 20px rgba(43,255,136,.15)}
  .symbol{flex:1;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);border:1px solid rgba(43,255,136,.4);box-shadow:0 0 20px rgba(43,255,136,.15),inset 0 0 15px rgba(43,255,136,.1);border-radius:12px;overflow:hidden}
  .symbol img{width:100%;height:100%;max-width:clamp(160px,22vw,280px);max-height:clamp(160px,22vw,280px);object-fit:contain}
  .fallback{color:var(--accent2);font-size:.92rem;padding:6px;text-align:center}
  .arrow{width:clamp(36px,4.5vw,44px);height:clamp(36px,4.5vw,44px);display:flex;align-items:center;justify-content:center;font-size:clamp(18px,2.5vw,20px);cursor:pointer;color:var(--fg);background:rgba(30,30,30,.8);border:1px solid rgba(43,255,136,.3);border-radius:8px}
  .arrow:hover{background:rgba(43,255,136,.15)}
  .action{margin:clamp(12px,2vw,16px) 0;display:flex;gap:clamp(8px,1.5vw,12px);justify-content:center}
  button{appearance:none;border:0;cursor:pointer;border-radius:8px;padding:10px 16px;font-weight:700;font-size:1rem;background:rgba(30,30,30,.9);color:var(--fg);border:2px solid rgba(43,255,136,.3);font-family:'Cinzel Decorative',serif}
  button:hover{background:rgba(43,255,136,.15)}
  .msg{min-height:28px;font-size:1.1rem;margin-top:6px}
  .success{color:var(--ok)} .fail{color:var(--err)}
  .footer{margin-top:clamp(12px,2vw,18px);color:var(--accent2);font-size:.95rem}

  /* RITUALE */
  #rituale{display:none;width:100%;max-width:min(1100px,96vw);margin:clamp(16px,2.5vw,24px) auto 0}
  .rituale-text{margin:12px auto 8px;line-height:1.45;color:var(--fg);font-size:clamp(14px,2vw,18px)}
  .rit-title{font-size:clamp(22px,4vw,36px);margin:8px 0 12px;color:var(--accent);text-shadow:0 0 10px var(--accent),0 0 24px var(--accent2);letter-spacing:.08em}

  .ritual-wrap{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:8px}
  .rit-gif{width:140px;height:140px;object-fit:cover;border-radius:8px;box-shadow:0 0 16px rgba(43,255,136,.25)}
  @media (max-width:900px){.rit-gif{display:none}}

  .pentacolo{position:relative;width:min(90vw,600px);height:min(90vw,600px);margin:0 auto 24px}
  .pentacolo svg{transform:rotate(180deg)} /* rovesciato */

  /* *** campi SUL pentacolo (punte) *** */
  .rit-field{position:absolute;transform:translate(-50%,-50%)}
  /* coordinate tarate sullo star rovesciato */
  .rf-top    {left:50%; top:22%;  width:66%;}
  .rf-left   {left:28%; top:77%;  width:48%;}
  .rf-right  {left:72%; top:77%;  width:48%;}

  .rit-field input{width:100%;padding:10px 12px;border-radius:10px;border:2px solid rgba(43,255,136,.35);background:rgba(10,10,10,.85);color:var(--fg);font-size:clamp(14px,2vw,16px)}
  .rit-btn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}
  .rit-msg{min-height:20px;margin-top:8px;font-size:1rem}

  @media (max-width:700px){
    /* su mobile li metto comunque sotto: più leggibili */
    .rf-top   {left:50%; top:106%; width:92%;}
    .rf-left  {left:50%; top:124%; width:92%;}
    .rf-right {left:50%; top:142%; width:92%;}
  }

  /* GIOCO */
  #game{display:none;width:100%;max-width:min(960px,96vw);margin:28px auto 0;text-align:center}
  #game h2{margin:8px 0 6px;font-size:clamp(20px,4vw,28px);color:var(--accent);text-shadow:0 0 10px var(--accent)}
  #canvasWrap{background:#000;border:2px solid rgba(43,255,136,.3);border-radius:10px;padding:8px}
  canvas{display:block;width:100%;height:auto;background:#000}
  .hud{color:var(--muted);margin-top:8px;font-size:clamp(14px,2vw,16px)}
  .score{color:var(--accent2);margin-left:6px}
</style>
</head>
<body>
  <main class="page">
    <!-- HERO -->
    <div class="hero" id="heroBox"></div>

    <h1>Combinazione di Simboli</h1>
    <p class="sub">Allinea i quattro simboli corretti per risvegliare l'oscuro portale.</p>

    <section class="panel" id="panel"></section>

    <div class="action">
      <button id="shuffle">Mescola</button>
      <button id="check">Verifica</button>
    </div>
    <div id="message" class="msg"></div>
    <div class="footer" id="hintBox"></div>

    <!-- RITUALE -->
    <section id="rituale">
      <p class="rituale-text" id="ritText"></p>
      <div class="rit-title">Inizia il Rituale</div>

      <div class="ritual-wrap">
        <img class="rit-gif" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExeHlhOXY3M3hsb3cxdnlkbDRsM3M3c2tpNHA2ejFoaHFudzE4ZDlwZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/9zOiTQ7RPxU7C/giphy.gif" alt="fuoco sinistro">
        <div class="pentacolo">
          <svg viewBox="0 0 100 100" width="100%" height="100%" aria-hidden="true" style="position:absolute;left:0;top:0;filter:drop-shadow(0 0 10px rgba(43,255,136,.35));">
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(43,255,136,.35)" stroke-width="2"/>
            <polygon points="50,6 61,40 96,40 67,60 78,94 50,73 22,94 33,60 4,40 39,40" fill="none" stroke="rgba(43,255,136,.55)" stroke-width="2"/>
          </svg>
          <!-- Campi SUL pentacolo -->
          <div class="rit-field rf-top"><input id="f1" type="text" placeholder="Ingrediente I"></div>
          <div class="rit-field rf-left"><input id="f2" type="text" placeholder="Ingrediente II"></div>
          <div class="rit-field rf-right"><input id="f3" type="text" placeholder="Ingrediente III"></div>

          <button class="rit-btn" id="completeBtn">Completa</button>
        </div>
        <img class="rit-gif" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExeHlhOXY3M3hsb3cxdnlkbDRsM3M3c2tpNHA2ejFoaHFudzE4ZDlwZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/9zOiTQ7RPxU7C/giphy.gif" alt="fuoco destro">
      </div>

      <div id="ritMsg" class="rit-msg"></div>
    </section>

    <!-- GIOCO -->
    <section id="game">
      <h2>La Corsa della Zucca</h2>
      <div id="canvasWrap"><canvas id="runner" width="900" height="300"></canvas></div>
      <div class="hud">Premi <strong>SPAZIO</strong> o <strong>↑</strong> (o tocca lo schermo) per saltare. Punteggio: <span class="score" id="score">0</span></div>
      <div class="cta"><button id="startGame">Avvia</button> <button id="restartGame" style="display:none">Riprova</button></div>
    </section>
  </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* HERO con fallback */
  const hero = document.getElementById('heroBox');
  const b = new Image(); b.src='media/home.png'; b.alt='Il Rituale';
  b.onload=()=>hero.appendChild(b);
  b.onerror=()=>{const fb=document.createElement('div');fb.className='hero-fallback';fb.textContent='MANCANTE: media/home.png';hero.appendChild(fb);};

  /* SIMBOLI */
  const SYMBOLS = Array.from({length:12},(_,i)=>({id:String(i+1),src:`./media/${i+1}.png`}));
  const TARGET = atob("MSwyLDMsNA==").split(","); // "1,2,3,4"

  const HINTS=[
    "Spesso gli oggetti dei rituali si nascondono nelle stanze più buie.",
    "Le scope delle streghe nascondono sempre qualcosa.",
    "Una volta ho sentito la storia di una \"casa del dolore\", forse si parlava di qualcosa di interessante?"
  ];
  document.getElementById('hintBox').textContent="Suggerimento: "+HINTS[Math.floor(Math.random()*HINTS.length)];

  const panel=document.getElementById('panel'), message=document.getElementById('message'),
        rituale=document.getElementById('rituale'), ritText=document.getElementById('ritText'),
        gameSec=document.getElementById('game');

  let state=[], ritualeShown=false;

  function renderSymbol(el,idx){
    el.innerHTML=''; const img=new Image(); img.src=SYMBOLS[idx].src; img.alt=`simbolo ${idx+1}`;
    img.onerror=()=>{el.innerHTML=`<div class="fallback">MANCANTE: ${SYMBOLS[idx].src}</div>`}; el.appendChild(img);
  }
  function createSlot(i){
    const wrap=document.createElement('div'); wrap.className='slot';
    const L=document.createElement('div'); L.className='arrow'; L.textContent='◀';
    const S=document.createElement('div'); S.className='symbol';
    const R=document.createElement('div'); R.className='arrow'; R.textContent='▶';
    wrap.append(L,S,R);
    state[i]=Math.floor(Math.random()*SYMBOLS.length); renderSymbol(S,state[i]);
    L.addEventListener('click',()=>{state[i]=(state[i]-1+SYMBOLS.length)%SYMBOLS.length;renderSymbol(S,state[i]);message.textContent='';});
    R.addEventListener('click',()=>{state[i]=(state[i]+1)%SYMBOLS.length;renderSymbol(S,state[i]);message.textContent='';});
    return wrap;
  }
  function build(){panel.innerHTML='';state=[];for(let i=0;i<4;i++)panel.appendChild(createSlot(i));}
  function shuffle(){for(let i=0;i<4;i++)state[i]=Math.floor(Math.random()*SYMBOLS.length);
    [...panel.children].forEach((slotEl,i)=>renderSymbol(slotEl.querySelector('.symbol'),state[i]));message.textContent='';}
  function check(){
    const picked=state.map(idx=>SYMBOLS[idx].id);
    const ok=picked.length===TARGET.length && picked.every((id,i)=>id===TARGET[i]);
    if(ok){
      message.className='msg success'; message.textContent='';
      if(!ritualeShown){
        ritText.textContent="Bene, molto bene. Quindi Herr Knock ti ha insegnato molto. Per procedere con il rituale è fondamentale trovare i tre ingredienti per Evocare il Principe delle Tenebre. Credo che tu possa trovarli all'interno del server, ma non sarà facile.";
        rituale.style.display='block'; rituale.scrollIntoView({behavior:'smooth'}); ritualeShown=true;
      }
    } else { message.className='msg fail'; message.textContent='sbagliato'; }
  }
  document.getElementById('shuffle').onclick=shuffle;
  document.getElementById('check').onclick=check;
  build();

  /* ===== RITUALE — ordine libero con classificazione ===== */
  const norm=(s)=>s.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,'').replace(/\s+/g,' ').trim();

  function classify(text){
    const v=norm(text); if(!v) return null;
    const has=(...ws)=>ws.every(w=>v.includes(w));
    // Candela nera
    if(v.includes('candela') && (v.includes('nera')||v.includes('nero'))) return 'CANDLE';
    // Coltello arrugginito con simbolo della bestia
    const rust = v.includes('arrugginito')||v.includes('arrugginita')||v.includes('ossidato')||v.includes('ossidata')||v.includes('ruggine');
    if(v.includes('coltello') && rust && has('simbolo','bestia')) return 'KNIFE';
    // Peli pubici di zombie femmina
    const peli = v.includes('peli')||v.includes('pelo');
    const pub  = v.includes('pubici')||v.includes('pubico');
    const fem  = v.includes('femmina')||v.includes('donna');
    if(peli && pub && v.includes('zombie') && fem) return 'HAIR';
    return null;
  }

  function submitRitual(){
    const types = [classify(document.getElementById('f1').value),
                   classify(document.getElementById('f2').value),
                   classify(document.getElementById('f3').value)];
    const set = new Set(types.filter(Boolean));
    const ok = set.has('CANDLE') && set.has('KNIFE') && set.has('HAIR') && types.every(t=>t!==null);

    const box=document.getElementById('ritMsg');
    if(ok){
      box.className='rit-msg success';
      box.textContent='Il cerchio si illumina… il portale si apre!';
      document.getElementById('game').style.display='block';
      document.getElementById('game').scrollIntoView({behavior:'smooth'});
    }else{
      box.className='rit-msg fail';
      box.textContent='La formula non risponde. Forse hai sbagliato gli ingredienti...';
    }
  }
  document.getElementById('completeBtn').onclick=submitRitual;
  ['f1','f2','f3'].forEach(id=>{
    document.getElementById(id).addEventListener('keydown',e=>{
      if(e.key==='Enter') submitRitual();
      e.stopPropagation(); // non “ruba” Space/Up al gioco mentre si scrive
    });
  });

  /* ===== MINIGIOCO (come prima) ===== */
  const cvs=document.getElementById('runner'), ctx=cvs.getContext('2d'),
        scoreEl=document.getElementById('score'), startBtn=document.getElementById('startGame'),
        restartBtn=document.getElementById('restartGame');
  let running=false, gameOver=false, score=0, lastSpawn=0, speed=6;
  const ground=cvs.height-40, player={x:80,y:ground-32,w:36,h:36,vy:0,onGround:true}, obstacles=[];
  const spawnObstacle=()=>{const w=26+Math.random()*18,h=40+Math.random()*60;obstacles.push({x:cvs.width+10,y:ground-h,w,h});};
  function drawPumpkin(p){ctx.fillStyle='var(--pumpkin)';ctx.beginPath();ctx.ellipse(p.x+p.w/2,p.y+p.h/2,p.w/2,p.h/2,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#7a5c2e';ctx.fillRect(p.x+p.w/2-3,p.y-6,6,8);ctx.fillStyle='#000';
    ctx.beginPath();ctx.moveTo(p.x+10,p.y+14);ctx.lineTo(p.x+18,p.y+8);ctx.lineTo(p.x+22,p.y+18);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(p.x+p.w-10,p.y+14);ctx.lineTo(p.x+p.w-18,p.y+8);ctx.lineTo(p.x+p.w-22,p.y+18);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(p.x+10,p.y+p.h-12);ctx.lineTo(p.x+16,p.y+p.h-8);ctx.lineTo(p.x+22,p.y+p.h-12);
    ctx.lineTo(p.x+28,p.y+p.h-8);ctx.lineTo(p.x+34,p.y+p.h-12);ctx.lineTo(p.x+40,p.y+p.h-8);ctx.lineTo(p.x+46,p.y+p.h-12);ctx.fill();}
  function drawGravestone(o){ctx.fillStyle='var(--stone)';ctx.fillRect(o.x,o.y+o.h-8,o.w,8);
    ctx.beginPath();ctx.moveTo(o.x,o.y+o.h-8);ctx.lineTo(o.x,o.y+12);ctx.quadraticCurveTo(o.x+o.w/2,o.y-10,o.x+o.w,o.y+12);
    ctx.lineTo(o.x+o.w,o.y+o.h-8);ctx.closePath();ctx.fill();}
  const resetGame=()=>{running=false;gameOver=false;score=0;speed=6;obstacles.length=0;player.y=ground-32;player.vy=0;player.onGround=true;scoreEl.textContent='0';};
  const jump=()=>{if(!running||gameOver)return;if(player.onGround){player.vy=-12.5;player.onGround=false;}};
  function loop(ts){
    if(!running)return;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle='rgba(43,255,136,.3)';ctx.beginPath();ctx.moveTo(0,ground+0.5);ctx.lineTo(cvs.width,ground+0.5);ctx.stroke();
    if(ts-lastSpawn>1300){spawnObstacle();lastSpawn=ts;if(speed<10)speed+=0.05;}
    for(let i=obstacles.length-1;i>=0;i--){const o=obstacles[i];o.x-=speed;drawGravestone(o);if(o.x+o.w<0)obstacles.splice(i,1);
      if(player.x<o.x+o.w&&player.x+player.w>o.x&&player.y<o.y+o.h&&player.y+player.h>o.y){gameOver=true;running=false;restartBtn.style.display='inline-block';}}
    player.vy+=0.7;player.y+=player.vy;if(player.y+player.h>=ground){player.y=ground-player.h;player.vy=0;player.onGround=true;}
    drawPumpkin(player);score+=0.1;scoreEl.textContent=Math.floor(score);requestAnimationFrame(loop);}
  window.addEventListener('keydown',e=>{
    const tag=document.activeElement&&document.activeElement.tagName;
    if(tag==='INPUT'||tag==='TEXTAREA')return;
    if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();jump();}
  });
  cvs.addEventListener('pointerdown',jump);
  document.getElementById('startGame').onclick=()=>{if(!running&&!gameOver){running=true;restartBtn.style.display='none';lastSpawn=performance.now();requestAnimationFrame(loop);}};
  document.getElementById('restartGame').onclick=()=>{resetGame();running=true;restartBtn.style.display='none';lastSpawn=performance.now();requestAnimationFrame(loop);};
});
</script>
</body>
</html>
