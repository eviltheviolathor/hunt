<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Il Rituale — Combinazione di Simboli</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap');

  :root{
    --bg:#050505; --fg:#e6e6e6; --muted:#9aa0a6;
    --accent:#2bff88; --accent2:#6bffda;             /* verde ectoplasma */
    --pumpkin:#ff7a18;                                /* arancione zucca */
    --stone:#5de6b3;                                  /* lapidi “spettrali” */
    --card:#0d0d0d; --ok:#22c55e; --err:#ff4d4d;
  }
  *{box-sizing:border-box}

  html,body{
    margin:0;
    background:radial-gradient(circle at 50% 15%, #111 0%, #000 80%);
    color:var(--fg);
    font-family:'Cinzel Decorative', serif;
  }

  .page{
    max-width:1600px; margin:0 auto;
    padding:clamp(12px,2vw,24px);
    display:flex; flex-direction:column; align-items:center; text-align:center;
  }

  .hero{width:100%; max-width:min(1000px, 96vw); margin:0 auto clamp(10px,2vw,18px)}
  .hero img{width:100%; height:auto; display:block; border-radius:10px}
  .hero-fallback{width:100%; padding:clamp(16px,2vw,28px); border:2px dashed rgba(43,255,136,.35); border-radius:10px; color:var(--accent2)}

  h1{font-size:clamp(24px,5vw,42px); margin:clamp(8px,1.5vw,12px) 0; color:var(--accent);
     text-shadow:0 0 12px var(--accent), 0 0 28px var(--accent2); letter-spacing:.06em;}
  .sub{color:var(--muted); margin:0 0 clamp(12px,2vw,18px); font-size:clamp(14px,2vw,18px)}

  .panel{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(min(220px, 42vw), 1fr));
    gap:clamp(12px,2vw,20px);
    width:100%; max-width:min(1200px, 96vw);
    padding:clamp(12px,2vw,16px);
    border-radius:16px; margin:0 auto;
    background:rgba(20,20,20,.85);
    box-shadow:0 0 40px rgba(43,255,136,.25), inset 0 0 20px rgba(43,255,136,.15);
  }
  .slot{background:radial-gradient(300px 300px at 50% 30%, rgba(43,255,136,.08), transparent 70%), var(--card);
        border:2px solid rgba(43,255,136,.3); border-radius:16px; padding:clamp(8px,1.8vw,12px);
        display:flex; align-items:center; justify-content:center; gap:clamp(8px,1.5vw,10px);
        min-height:clamp(200px, 28vw, 320px); box-shadow:inset 0 0 20px rgba(43,255,136,.15);}
  .symbol{flex:1; display:flex; align-items:center; justify-content:center;
          background:rgba(0,0,0,.6); border:1px solid rgba(43,255,136,.4);
          box-shadow:0 0 20px rgba(43,255,136,.15), inset 0 0 15px rgba(43,255,136,.1);
          border-radius:12px; overflow:hidden;}
  .symbol img{width:100%; height:100%; max-width:clamp(160px, 22vw, 280px); max-height:clamp(160px, 22vw, 280px); object-fit:contain; display:block}
  .fallback{color:var(--accent2); font-size:.92rem; padding:6px; text-align:center}
  .arrow{width:clamp(36px,4.5vw,44px); height:clamp(36px,4.5vw,44px); display:flex; align-items:center; justify-content:center;
         font-size:clamp(18px,2.5vw,20px); cursor:pointer; color:var(--fg);
         background:rgba(30,30,30,.8); border:1px solid rgba(43,255,136,.3); border-radius:8px;}
  .arrow:hover{background:rgba(43,255,136,.15)}

  .action{margin:clamp(12px,2vw,16px) 0; display:flex; gap:clamp(8px,1.5vw,12px); justify-content:center}
  button{appearance:none; border:0; cursor:pointer; border-radius:8px; padding:10px 16px; font-weight:700; font-size:1rem;
         background:rgba(30,30,30,.9); color:var(--fg); border:2px solid rgba(43,255,136,.3); font-family:'Cinzel Decorative', serif;}
  button:hover{background:rgba(43,255,136,.15)}
  .msg{min-height:28px; font-size:1.1rem; margin-top:6px}
  .success{color:var(--ok)} .fail{color:var(--err)}
  .footer{margin-top:clamp(12px,2vw,18px); color:var(--accent2); font-size:.95rem}

  /* RITUALE */
  #rituale{display:none; width:100%; max-width:min(900px, 96vw); margin:clamp(16px,2.5vw,24px) auto 0}
  .rituale-text{margin:12px auto 20px; line-height:1.45; color:var(--fg); font-size:clamp(14px,2vw,18px)}
  .pentacolo{position:relative; width:min(90vw,600px); height:min(90vw,600px); margin:0 auto 16px}
  /* pentacolo rovesciato */
  .pentacolo svg{transform:rotate(180deg)}
  /* campi NON sovrapposti al pentacolo */
  .rit-field{position:absolute; transform:translate(-50%,-50%);}
  .rf-top   {left:50%; top:-6%;  width:60%;}
  .rf-left  {left:15%; top:88%;  width:42%;}
  .rf-right {left:85%; top:88%;  width:42%;}
  .rit-field input{width:100%; padding:10px 12px; border-radius:10px; border:2px solid rgba(43,255,136,.35);
                   background:rgba(10,10,10,.85); color:var(--fg); font-size:clamp(14px,2vw,16px)}
  .rit-btn{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%)}
  .rit-msg{min-height:20px; margin-top:8px; font-size:1rem}
  @media (max-width:700px){
    .rf-top   {left:50%; top:106%; width:92%;}
    .rf-left  {left:50%; top:122%; width:92%;}
    .rf-right {left:50%; top:138%; width:92%;}
  }

  /* GIOCO */
  #game{display:none; width:100%; max-width:min(960px,96vw); margin:28px auto 0; text-align:center}
  #game h2{margin:8px 0 6px; font-size:clamp(20px,4vw,28px); color:var(--accent); text-shadow:0 0 10px var(--accent)}
  #canvasWrap{background:#000; border:2px solid rgba(43,255,136,.3); border-radius:10px; padding:8px}
  canvas{display:block; width:100%; height:auto; background:#000}
  .hud{color:var(--muted); margin-top:8px; font-size:clamp(14px,2vw,16px)}
  .score{color:var(--accent2); margin-left:6px}
  .cta{margin-top:10px}
</style>
</head>
<body>
  <main class="page">
    <!-- Banner con fallback -->
    <div class="hero" id="heroBox"></div>

    <h1>Combinazione di Simboli</h1>
    <p class="sub">Allinea i quattro simboli corretti per risvegliare l'oscuro portale.</p>

    <section class="panel" id="panel"></section>

    <div class="action">
      <button id="shuffle">Mescola</button>
      <button id="check">Verifica</button>
    </div>
    <div id="message" class="msg"></div>
    <div class="footer" id="hintBox"></div>

    <!-- Sezione rituale -->
    <section id="rituale">
      <p class="rituale-text" id="ritText"></p>

      <div class="pentacolo">
        <svg viewBox="0 0 100 100" width="100%" height="100%" aria-hidden="true"
             style="position:absolute;left:0;top:0;filter:drop-shadow(0 0 10px rgba(43,255,136,.35));">
          <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(43,255,136,.35)" stroke-width="2"/>
          <polygon points="50,6 61,40 96,40 67,60 78,94 50,73 22,94 33,60 4,40 39,40"
                   fill="none" stroke="rgba(43,255,136,.55)" stroke-width="2"/>
        </svg>
        <!-- 3 campi NON sovrapposti -->
        <div class="rit-field rf-top"><input id="f1" type="text" placeholder="Ingrediente I"></div>
        <div class="rit-field rf-left"><input id="f2" type="text" placeholder="Ingrediente II"></div>
        <div class="rit-field rf-right"><input id="f3" type="text" placeholder="Ingrediente III"></div>

        <button class="rit-btn" id="completeBtn">Completa</button>
      </div>
      <div id="ritMsg" class="rit-msg"></div>
    </section>

    <!-- Gioco: si sblocca dopo il rituale -->
    <section id="game">
      <h2>La Corsa della Zucca</h2>
      <div id="canvasWrap">
        <canvas id="runner" width="900" height="300"></canvas>
      </div>
      <div class="hud">
        Premi <strong>SPAZIO</strong> o <strong>↑</strong> (o tocca lo schermo) per saltare.
        Punteggio: <span class="score" id="score">0</span>
      </div>
      <div class="cta">
        <button id="startGame">Avvia</button>
        <button id="restartGame" style="display:none">Riprova</button>
      </div>
    </section>

    <section id="nextStep" style="display:none; margin-top:22px;"></section>
  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* Banner con fallback */
  const hero = document.getElementById('heroBox');
  const b = new Image();
  b.src = 'media/home.png'; b.alt = 'Il Rituale';
  b.onload = ()=> hero.appendChild(b);
  b.onerror = ()=>{ const fb=document.createElement('div'); fb.className='hero-fallback'; fb.textContent='MANCANTE: media/home.png'; hero.appendChild(fb); };

  /* Simboli 1..12 */
  const SYMBOLS = Array.from({length:12}, (_,i) => ({ id:String(i+1), src:`./media/${i+1}.png` }));
  const TARGET = atob("MSwyLDMsNA==").split(","); // "1,2,3,4"

  /* Suggerimento casuale */
  const HINTS = [
    "Spesso gli oggetti dei rituali si nascondono nelle stanze più buie.",
    "Le scope delle streghe nascondono sempre qualcosa.",
    "Una volta ho sentito la storia di una \"casa del dolore\", forse si parlava di qualcosa di interessante?"
  ];
  document.getElementById('hintBox').textContent =
    "Suggerimento: " + HINTS[Math.floor(Math.random()*HINTS.length)];

  const panel   = document.getElementById('panel');
  const message = document.getElementById('message');
  const rituale = document.getElementById('rituale');
  const ritText = document.getElementById('ritText');
  const gameSec = document.getElementById('game');

  let state = [];
  let ritualeShown = false;

  function renderSymbol(el, idx){
    el.innerHTML = '';
    const img = new Image();
    img.src = SYMBOLS[idx].src;
    img.alt = `simbolo ${idx+1}`;
    img.onerror = ()=>{ el.innerHTML = `<div class="fallback">MANCANTE: ${SYMBOLS[idx].src}</div>`; };
    el.appendChild(img);
  }
  function createSlot(i){
    const wrap = document.createElement('div'); wrap.className='slot';
    const left = document.createElement('div'); left.className='arrow'; left.textContent='◀';
    const sym  = document.createElement('div'); sym.className='symbol';
    const right= document.createElement('div'); right.className='arrow'; right.textContent='▶';
    wrap.append(left, sym, right);

    state[i] = Math.floor(Math.random()*SYMBOLS.length);
    renderSymbol(sym, state[i]);

    left.addEventListener('click', ()=>{ state[i]=(state[i]-1+SYMBOLS.length)%SYMBOLS.length; renderSymbol(sym,state[i]); message.textContent=''; });
    right.addEventListener('click',()=>{ state[i]=(state[i]+1)%SYMBOLS.length; renderSymbol(sym,state[i]); message.textContent=''; });

    return wrap;
  }
  function build(){ panel.innerHTML=''; state=[]; for(let i=0;i<4;i++) panel.appendChild(createSlot(i)); }
  function shuffle(){
    for(let i=0;i<4;i++) state[i]=Math.floor(Math.random()*SYMBOLS.length);
    [...panel.children].forEach((slotEl,i)=> renderSymbol(slotEl.querySelector('.symbol'), state[i]));
    message.textContent='';
  }
  function check(){
    const picked = state.map(idx=>SYMBOLS[idx].id);
    const ok = picked.length===TARGET.length && picked.every((id,i)=> id===TARGET[i]);
    if(ok){
      message.className='msg success'; message.textContent='';
      if(!ritualeShown){
        ritText.textContent =
          "Bene, molto bene. Quindi Herr Knock ti ha insegnato molto. Per procedere con il rituale è fondamentale trovare i tre ingredienti per Evocare il Principe delle Tenebre. Credo che tu possa trovarli all'interno del server, ma non sarà facile.";
        rituale.style.display='block';
        rituale.scrollIntoView({behavior:'smooth'});
        ritualeShown = true;
      }
    } else { message.className='msg fail'; message.textContent='sbagliato'; }
  }
  document.getElementById('shuffle').onclick = shuffle;
  document.getElementById('check').onclick   = check;
  build();

  /* RITUALE — verifica per parole chiave (tollerante) */
  const norm = (s) => s.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,'').replace(/\s+/g,' ').trim();
  const want = [
    ['candela','nera'],
    ['coltello','arrugginito','simbolo','bestia'],
    ['peli','pubici','zombie','femmina']
  ];
  const hasAll = (words, input) => { const v = norm(input).split(' '); return words.every(w => v.includes(w)); };

  document.getElementById('completeBtn').onclick = ()=>{
    const ok =
      hasAll(want[0], document.getElementById('f1').value) &&
      hasAll(want[1], document.getElementById('f2').value) &&
      hasAll(want[2], document.getElementById('f3').value);

    const box = document.getElementById('ritMsg');
    if(ok){
      box.className='rit-msg success';
      box.textContent='Il cerchio si illumina… il portale si apre!';
      gameSec.style.display='block'; // sblocca il gioco
      gameSec.scrollIntoView({behavior:'smooth'});
    }else{
      box.className='rit-msg fail';
      box.textContent='La formula non risponde. Forse hai sbagliato gli ingredienti...';
    }
  };

  /* =========================
     MINIGIOCO — Pumpkin Runner
     ========================= */
  const cvs = document.getElementById('runner');
  const ctx = cvs.getContext('2d');
  const scoreEl = document.getElementById('score');
  const startBtn = document.getElementById('startGame');
  const restartBtn = document.getElementById('restartGame');

  let running=false, gameOver=false, score=0, lastSpawn=0, speed=6;
  const ground = cvs.height - 40;

  const player = { x: 80, y: ground-32, w: 36, h: 36, vy: 0, onGround: true };

  const obstacles = [];

  function spawnObstacle(){
    const w = 26 + Math.random()*18;
    const h = 40 + Math.random()*60;
    obstacles.push({ x:cvs.width+10, y:ground-h, w, h });
  }

  function drawPumpkin(p){
    // corpo
    ctx.fillStyle = 'var(--pumpkin)';
    ctx.beginPath();
    ctx.ellipse(p.x + p.w/2, p.y + p.h/2, p.w/2, p.h/2, 0, 0, Math.PI*2);
    ctx.fill();
    // gambo
    ctx.fillStyle = '#7a5c2e';
    ctx.fillRect(p.x + p.w/2 - 3, p.y - 6, 6, 8);
    // occhi
    ctx.fillStyle = '#000';
    ctx.beginPath(); ctx.moveTo(p.x+10, p.y+14); ctx.lineTo(p.x+18, p.y+8); ctx.lineTo(p.x+22, p.y+18); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(p.x+p.w-10, p.y+14); ctx.lineTo(p.x+p.w-18, p.y+8); ctx.lineTo(p.x+p.w-22, p.y+18); ctx.closePath(); ctx.fill();
    // bocca
    ctx.beginPath();
    ctx.moveTo(p.x+10, p.y+p.h-12);
    ctx.lineTo(p.x+16, p.y+p.h-8);
    ctx.lineTo(p.x+22, p.y+p.h-12);
    ctx.lineTo(p.x+28, p.y+p.h-8);
    ctx.lineTo(p.x+34, p.y+p.h-12);
    ctx.lineTo(p.x+40, p.y+p.h-8);
    ctx.lineTo(p.x+46, p.y+p.h-12);
    ctx.fill();
  }

  function drawGravestone(o){
    ctx.fillStyle = 'var(--stone)';
    // base
    ctx.fillRect(o.x, o.y + o.h - 8, o.w, 8);
    // lapide arrotondata
    ctx.beginPath();
    ctx.moveTo(o.x, o.y + o.h - 8);
    ctx.lineTo(o.x, o.y + 12);
    ctx.quadraticCurveTo(o.x + o.w/2, o.y - 10, o.x + o.w, o.y + 12);
    ctx.lineTo(o.x + o.w, o.y + o.h - 8);
    ctx.closePath();
    ctx.fill();
  }

  function resetGame(){
    running=false; gameOver=false; score=0; speed=6;
    obstacles.length=0;
    player.y = ground-32; player.vy=0; player.onGround=true;
    scoreEl.textContent = '0';
  }

  function jump(){
    if(!running || gameOver) return;
    if(player.onGround){
      player.vy = -12.5;
      player.onGround = false;
    }
  }

  function loop(ts){
    if(!running) return;

    ctx.clearRect(0,0,cvs.width,cvs.height);

    // terreno
    ctx.strokeStyle = 'rgba(43,255,136,.3)';
    ctx.beginPath(); ctx.moveTo(0, ground+0.5); ctx.lineTo(cvs.width, ground+0.5); ctx.stroke();

    // spawn ostacoli
    if(ts - lastSpawn > 1300){ spawnObstacle(); lastSpawn = ts; if(speed < 10) speed += 0.05; }

    // aggiorna e disegna ostacoli
    for(let i=obstacles.length-1;i>=0;i--){
      const o = obstacles[i];
      o.x -= speed;
      drawGravestone(o);
      if(o.x + o.w < 0) obstacles.splice(i,1);
      // collisione AABB
      if(player.x < o.x + o.w && player.x + player.w > o.x &&
         player.y < o.y + o.h && player.y + player.h > o.y){
        gameOver = true; running = false;
        restartBtn.style.display = 'inline-block';
      }
    }

    // fisica player
    player.vy += 0.7;             // gravità
    player.y += player.vy;
    if(player.y + player.h >= ground){
      player.y = ground - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    drawPumpkin(player);

    // punteggio
    score += 0.1;
    scoreEl.textContent = Math.floor(score);

    requestAnimationFrame(loop);
  }

  // input
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); jump(); } });
  cvs.addEventListener('pointerdown', jump);

  startBtn.onclick = ()=>{ if(!running && !gameOver){ running = true; restartBtn.style.display='none'; lastSpawn=performance.now(); requestAnimationFrame(loop);} };
  restartBtn.onclick= ()=>{ resetGame(); running = true; restartBtn.style.display='none'; lastSpawn=performance.now(); requestAnimationFrame(loop); };

});
</script>
</body>
</html>
